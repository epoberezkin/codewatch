# CodeWatch Comprehensive UX & Technical Analysis

**Date**: 2026-02-01
**Scope**: Full codebase analysis — API routes, services, client code, tests, DB schema
**Total issues**: 77 (11 P0, 24 P1, 42 P2)

---

## P0 — BROKEN / CRITICAL (11 issues)

| # | Area | Issue | Location |
|---|------|-------|----------|
| 1 | Services | **Cost calculation bug**: `calculateLevelCost(totalTokens, 'thorough', pricing)` uses FULL token count instead of `thoroughTokens`. Thorough/opportunistic estimates are 3-6x too expensive. | `tokens.ts:86-91` |
| 2 | Services | **Uninitialized classification reference**: Checks `existingProject[0].category` without first verifying `existingProject.length > 0`. Crashes if project doesn't exist. | `audit.ts:322` |
| 3 | Services | **Race condition in clone path**: `fs.existsSync()` check then `mkdir` is TOCTOU-vulnerable between concurrent processes. | `git.ts:62` |
| 4 | Services | **Tool execution infinite loop**: If Claude tool always fails the same way, `componentAnalysis.ts` loops indefinitely with no max-turn cap. | `componentAnalysis.ts:285-298` |
| 5 | Services | **Silent data corruption in inheritance**: Inherited findings from base audit inserted without dedup validation. If base has duplicates, they propagate. | `audit.ts:287-300` |
| 6 | Services | **Path traversal check insufficient**: `fullPath.startsWith(path.resolve(repo.localPath) + path.sep)` — `/repo` would pass for `/repo2/file`. | `audit.ts:105`, `planning.ts:105` |
| 7 | API | **Race condition in DELETE /api/audit/:id**: Audit existence check and delete are separate DB calls; concurrent deletes cause confusing 404s. | `api.ts:2034-2078` |
| 8 | Client | **Null check missing on comment submission**: `auditId` from `getParam('auditId')` could be null; comment posts silently fail. | `report.ts:477-482` |
| 9 | Client | **Infinite polling with no timeout**: Component analysis status polling has no max-retry logic. Tab polls forever if status never reaches terminal state. | `estimate.ts:316-341` |
| 10 | DB | **Missing FK**: `audit_findings.component_id` has no `REFERENCES components(id)` constraint — allows orphaned component references. | `sql/002:70` |
| 11 | DB | **Missing FK**: `projects.component_analysis_id` has no explicit FK constraint — orphaned projects if component_analyses deleted. | `sql/002:73` |

---

## P1 — SIGNIFICANT UX PROBLEMS (24 issues)

| # | Area | Issue | Location |
|---|------|-------|----------|
| 12 | API | **Silent failures in estimation**: Rough estimate returns `cloneErrors` field; precise estimate silently sets `files = []` on error. Inconsistent behavior. | `api.ts:732-845` |
| 13 | API | **Session query duplicated 10+ times**: Same `SELECT * FROM sessions WHERE...` pattern copy-pasted across all authenticated endpoints. | `api.ts` throughout |
| 14 | API | **Three-tier access control copy-pasted**: Identical redaction logic (`redactedSevs = new Set(...)`) in `/audit/:id/report` and `/audit/:id/findings`. | `api.ts:1342-1431, 1557-1632` |
| 15 | API | **Confusing duplicate project response**: Returns `{ projectId, existing: true }` — unclear whether repos were synced or if this is a new creation. | `api.ts:201` |
| 16 | API | **No ownership check on component analysis**: Any authenticated user can trigger `POST /api/projects/:id/analyze-components` on any project. | `api.ts:2167-2233` |
| 17 | API | **publish/unpublish skip project-audit validation**: Don't verify the `auditId` belongs to the project resolved for ownership check. | `api.ts:1838-1873` |
| 18 | Services | **Synthesis errors swallowed**: If synthesis fails, audit completes without `report_summary` and no error message is set. User thinks audit succeeded. | `audit.ts:651-662` |
| 19 | Services | **Destructive component deletion**: Re-analysis deletes all components not referenced by current `audit_components`, destroying historical data. | `componentAnalysis.ts:416-423` |
| 20 | Services | **Incremental audits silently downgrade**: If shallow clone lacks history, `diffBetweenCommits` falls back to "all files changed" — full audit with no warning. | `git.ts:234` |
| 21 | Services | **Planning returns 0 files with no logging**: Fallback to old heuristic happens silently. User has no visibility into why strategy changed. | `audit.ts:378-399` |
| 22 | Client | **Audit polling error swallowed**: Catch block only logs to console. Page appears stuck with stale data, no user feedback. | `audit.ts:48-51` |
| 23 | Client | **Inconsistent error handling across pages**: `home.ts` uses inline notices, `estimate.ts` uses `alert()`, `report.ts` uses `alert()`, `projects.ts` uses inline notices. | Multiple client files |
| 24 | Client | **Estimate cards not keyboard-accessible**: Divs with click handlers but no `role="button"`, no `aria-pressed`, no keyboard event handler. | `estimate.html:80-90` |
| 25 | Client | **No loading state feedback on branch loading failure**: Spinner stays visible after error; user can't tell if loading or broken. | `estimate.ts:542-544` |
| 26 | Client | **Audit polling continues after page exit**: `setInterval(poll, 3000)` never cleared. Continues making API calls indefinitely. | `audit.ts:154-156` |
| 27 | Client | **Component checkboxes lose state on re-render**: When component list re-renders, all checkboxes reset to `checked=true`, losing user selections. | `estimate.ts:205-232` |
| 28 | Client | **No back-to-project link from report**: Report has "New Audit" but no "Back to Project" navigation. | `report.html:45` |
| 29 | Client | **Mobile nav hidden with no hamburger menu**: `style.css:994-996` hides `.nav-links` on mobile but provides no alternative navigation. | `style.css:994-996` |
| 30 | DB | **Missing index on `audit_findings(component_id)`**: Component-to-findings queries do full table scans. | `sql/002` |
| 31 | DB | **Missing index on `project_repos(repo_id)`**: Frequent JOIN queries scan full table. | `sql/001` |
| 32 | DB | **No end-to-end user journey test**: No test validates complete Create -> Classify -> Audit -> Publish -> Browse flow. | Test suite |
| 33 | DB | **Session expiration never tested**: `expires_at` field exists but no test validates expired sessions are rejected. | `auth.test.ts` |
| 34 | DB | **Missing ON DELETE CASCADE on `audit_components -> components`**: Deleting a component orphans `audit_components` rows. | `sql/002:60-67` |
| 35 | Services | **Poor audit failure messaging**: Says "incomplete analysis" but doesn't explain what failed or how to retry. | `audit.ts:543-546` |

---

## P2 — MINOR IMPROVEMENTS (42 issues)

### API layer

| # | Issue | Location |
|---|-------|----------|
| 36 | Missing pagination on `/api/reports` (hardcoded LIMIT 50, no offset parameter) | `api.ts:2395` |
| 37 | Missing pagination on `/api/project/:id/audits` (no LIMIT clause at all) | `api.ts:1025` |
| 38 | Inconsistent batch response shapes: `{ updated: true }` vs `{ ok: true }` | `api.ts:658, 1687` |
| 39 | Inconsistent null handling for license fields (3 different patterns) | `api.ts:50, 463, 572` |
| 40 | Misleading 503 for permanent config error (missing `ANTHROPIC_SERVICE_KEY`) | `api.ts:805` |
| 41 | No duplicate component ID validation in `/api/estimate/components` | `api.ts:936` |
| 42 | No branch existence validation in `PUT /api/projects/:id/branches` | `api.ts:605` |
| 43 | Potential null pointer in `notify-owner` (`findingCount.rows[0].count`) | `api.ts:1984` |
| 44 | Insufficient logging for publish/unpublish and finding status changes | `api.ts:1639, 1838` |
| 45 | No timeout handling on estimation endpoints | `api.ts` (estimate, precise, components) |

### Services layer

| # | Issue | Location |
|---|-------|----------|
| 46 | `estimateCosts` and `estimateCostsFromTokenCount` duplicate 20+ lines of calculation | `tokens.ts:48-101` |
| 47 | `SKIP_DIRS` defined in 3 places (audit.ts, planning.ts, git.ts) — should be single export | Multiple |
| 48 | `SECURITY_CRITICAL_PATTERNS` defined in 2 places (audit.ts, planning.ts) — should be shared | Multiple |
| 49 | `selectFiles` hardcoded percentages duplicate planning.ts thresholds | `audit.ts:729-750` |
| 50 | `readFileContent` silently returns null for any error (file not found, permission denied, I/O) | `git.ts:204-213` |
| 51 | `listOrgRepos` silently falls back to `listUserRepos` on 404 | `github.ts:115-116` |
| 52 | `generateFingerprint` uses `code_snippet.substring(0, 100)` — null snippet creates collisions | `audit.ts:813` |
| 53 | Integer parsing without validation in cost estimation | `tokens.ts:199-200` |
| 54 | `getCommitDate` uses committer date not author date (breaks for force-pushes) | `github.ts:280-298` |
| 55 | Progress updates inside componentAnalysis loop add O(turns) DB roundtrips | `componentAnalysis.ts:232-235` |

### Client layer

| # | Issue | Location |
|---|-------|----------|
| 56 | `curateBranches()` duplicated in `home.ts` and `estimate.ts` — should be in `common.ts` | `home.ts:296-319`, `estimate.ts:482-498` |
| 57 | Duplicate "Add as Project" handlers in `project.ts` and `report.ts` | `project.ts:242-281`, `report.ts:264-301` |
| 58 | Duplicate error rendering pattern (`notice notice-error`) across 5+ files | Multiple client files |
| 59 | No `AbortController` timeout on API requests in `apiFetch()` | `common.ts:37-67` |
| 60 | Severity badge colors may fail WCAG AA contrast (medium yellow on white) | `style.css:369-373` |
| 61 | No "X results" counter on repo search filter | `home.ts:341-350` |
| 62 | No visual distinction for active "My Projects" filter mode | `projects.ts:45-49` |
| 63 | No API key format validation feedback in real-time (only on submit) | `estimate.ts:283-300` |
| 64 | No explanation of "incremental" vs "fresh" audit modes in UI | `estimate.html:47-50` |
| 65 | File status icons use Unicode chars that may not render in all fonts | `audit.ts:137-142` |
| 66 | No total project count on browse page | `projects.ts` |
| 67 | Responsive issue: `minmax(300px, 1fr)` grid overflows on phones <300px | `style.css:635` |
| 68 | Finding status dropdown shows raw `false_positive` and `wont_fix` without formatting | `report.ts:406-412` |
| 69 | Theme toggle uses emoji that may render inconsistently | `common.ts:15` |
| 70 | Report filter dropdowns don't indicate when filters are active | `report.ts:334-369` |
| 71 | External links missing consistent `target="_blank"` | `project.ts:233` |

### Tests & DB

| # | Issue | Location |
|---|-------|----------|
| 72 | Null branch fallback to `default_branch` not tested | `projects.test.ts:182-207` |
| 73 | Cascade delete test doesn't verify `audit_plan` and `component_analyses` cleanup | `delete.test.ts:156-196` |
| 74 | Model pricing hardcoded in both `setup.ts:78-81` and `sql/001:222-225` — no single source of truth | Multiple |
| 75 | File selection edge cases untested (empty list, all over budget, zero-token files) | `planning.test.ts:328-398` |
| 76 | Missing `CHECK` constraint preventing self-referencing `project_dependencies` | `sql/002` |
| 77 | `audit_commits.repo_id` allows NULL despite being used for attribution | `sql/001:134-140` |

---

## Summary

| Priority | Count | Key Themes |
|----------|-------|------------|
| **P0** | 11 | Cost calc 3-6x wrong, missing null checks, race conditions, missing FK constraints |
| **P1** | 24 | Silent failures, copy-pasted access control, no keyboard accessibility, missing indexes, no mobile nav |
| **P2** | 42 | Code duplication (5 instances), missing pagination, inconsistent error handling, missing tests |
| **Total** | **77** | |

---

## Top 5 Highest-Impact Fixes

1. **tokens.ts:86-91** — Cost calculation uses wrong token count for thorough/opportunistic. Every non-full estimate is 3-6x wrong.
2. **audit.ts:651-662** — Synthesis failures complete silently. Users see "completed" audits with no summary and no error.
3. **componentAnalysis.ts:416-423** — Re-analysis destroys all unselected components. Historical data lost.
4. **api.ts:2167-2233** — No ownership check on component analysis. Any authenticated user can trigger analysis on any project.
5. **Mobile navigation** — No hamburger menu means mobile users cannot navigate between pages at all.

---

## Top 5 Code Quality Improvements

1. Extract session query into shared middleware (eliminates 10+ copies)
2. Extract three-tier access control into shared function (eliminates 2 copies)
3. Move `SKIP_DIRS`, `SECURITY_CRITICAL_PATTERNS`, `curateBranches()` to shared modules (eliminates 3+3+2 copies)
4. Add `AbortController` timeouts to all API calls (client and server)
5. Add missing DB indexes on `audit_findings(component_id)` and `project_repos(repo_id)`
